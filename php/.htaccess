RewriteEngine On

# Si le fichier ou dossier existe, on ne touche pas
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f

# Réécriture
RewriteRule ^(.+)$ index.php [L]

# Sécurité : restreindre les méthodes HTTP
<LimitExcept GET POST>
    Require all denied
</LimitExcept>

# Sécurité : interdire l'accès aux fichiers cachés (commençant par un point)
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Sécurité : interdire l'accès aux fichiers de configuration
<FilesMatch "(\.env|\.htaccess|\.htpasswd|config\.php|wp-config\.php)">
    Require all denied
</FilesMatch>

# Sécurité : protéger les fichiers PHP sensibles
<FilesMatch "(^config\.php|^settings\.php|^db\.php|^admin\.php)">
    Require all denied
</FilesMatch>

# Sécurité : interdire l'accès aux fichiers de sauvegarde et de configuration courants
<FilesMatch "\.(sql|bak|old|backup|ini|log|conf|env|yml|yaml|lock|zip|tar|gz|7z)$">
  Require all denied
</FilesMatch>

# Sécurité : désactiver l'indexation des répertoires
Options -Indexes

# Sécurité : en-têtes HTTP de sécurité
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "no-referrer-when-downgrade"
Header always set Content-Security-Policy "default-src 'self'; script-src 'self';
    style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'self'; form-action 'self'; base-uri 'self';"

# Redirection HTTP vers HTTPS
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://logemangue%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Compression des fichiers texte
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json application/xml
</IfModule>     

# Mise en cache des ressources statiques
<IfModule mod_expires.c>   
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"   
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/html "access plus 600 seconds"
</IfModule>

# Bloquer les requêtes malveillantes courantes
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*object.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*applet.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*embed.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*form.*(\>|%3E) [NC]
    RewriteRule ^ - [F] 
</IfModule>

# Limiter le nombre de requêtes pour prévenir les attaques par force brute
<IfModule mod_evasive20.c>
    DOSHashTableSize 3097
    DOSPageCount 2
    DOSSiteCount 50
    DOSPageInterval 1
    DOSSiteInterval 1
    DOSBlockingPeriod 10
</IfModule> 

# Protection contre le hotlinking des images
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?logemangue\.com/ [NC]
    RewriteRule \.(jpg|jpeg|png|gif)$ - [F,NC]
</IfModule>
